use phf::phf_map;

// 省份映射（使用 itemIndex 作为 code）
static PROVINCE_MAP: phf::Map<&'static str, i16> = phf_map! {
    "全国" => 1,
    "北京市" => 11,
    "天津市" => 12,
    "河北省" => 13,
    "山西省" => 14,
    "内蒙古自治区" => 15,
    "辽宁省" => 21,
    "吉林省" => 22,
    "黑龙江省" => 23,
    "上海市" => 31,
    "江苏省" => 32,
    "浙江省" => 33,
    "安徽省" => 34,
    "福建省" => 35,
    "江西省" => 36,
    "山东省" => 37,
    "河南省" => 41,
    "湖北省" => 42,
    "湖南省" => 43,
    "广东省" => 44,
    "广西自治区" => 45,
    "海南省" => 46,
    "重庆市" => 50,
    "四川省" => 51,
    "贵州省" => 52,
    "云南省" => 53,
    "西藏自治区" => 54,
    "陕西省" => 61,
    "甘肃省" => 62,
    "青海省" => 63,
    "宁夏自治区" => 64,
    "新疆自治区" => 65,
    "台湾省" => 71,
    "香港" => 81,
    "澳门" => 82,
};

// 省份 -> 城市映射（嵌套结构）
static PROVINCE_CITY_MAP: phf::Map<&'static str, phf::Map<&'static str, i16>> = phf_map! {
    "全国" => phf_map! {}, // 全国无具体城市

    "北京市" => phf_map! {
        "北京市" => 1101,
    },

    "天津市" => phf_map! {
        "天津市" => 1201,
    },

    "河北省" => phf_map! {
        "石家庄市" => 1301,
        "唐山市" => 1302,
        "秦皇岛市" => 1303,
        "邯郸市" => 1304,
        "邢台市" => 1305,
        "保定市" => 1306,
        "张家口市" => 1307,
        "承德市" => 1308,
        "沧州市" => 1309,
        "廊坊市" => 1310,
        "衡水市" => 1311,
    },

    "山西省" => phf_map! {
        "太原市" => 1401,
        "大同市" => 1402,
        "阳泉市" => 1403,
        "长治市" => 1404,
        "晋城市" => 1405,
        "朔州市" => 1406,
        "晋中市" => 1407,
        "运城市" => 1408,
        "忻州市" => 1409,
        "临汾市" => 1410,
        "吕梁市" => 1411,
    },

    "内蒙古自治区" => phf_map! {
        "呼和浩特市" => 1501,
        "包头市" => 1502,
        "乌海市" => 1503,
        "赤峰市" => 1504,
        "通辽市" => 1505,
        "鄂尔多斯市" => 1506,
        "呼伦贝尔市" => 1507,
        "巴彦淖尔市" => 1508,
        "乌兰察布市" => 1509,
        "兴安盟" => 1522,
        "锡林郭勒盟" => 1525,
        "阿拉善盟" => 1529,
    },

    "辽宁省" => phf_map! {
        "沈阳市" => 2101,
        "大连市" => 2102,
        "鞍山市" => 2103,
        "抚顺市" => 2104,
        "本溪市" => 2105,
        "丹东市" => 2106,
        "锦州市" => 2107,
        "营口市" => 2108,
        "阜新市" => 2109,
        "辽阳市" => 2110,
        "盘锦市" => 2111,
        "铁岭市" => 2112,
        "朝阳市" => 2113,
        "葫芦岛市" => 2114,
    },

    "吉林省" => phf_map! {
        "长春市" => 2201,
        "吉林市" => 2202,
        "四平市" => 2203,
        "辽源市" => 2204,
        "通化市" => 2205,
        "白山市" => 2206,
        "松原市" => 2207,
        "白城市" => 2208,
        "延边朝鲜族自治州" => 2224,
    },

    "黑龙江省" => phf_map! {
        "哈尔滨市" => 2301,
        "齐齐哈尔市" => 2302,
        "鸡西市" => 2303,
        "鹤岗市" => 2304,
        "双鸭山市" => 2305,
        "大庆市" => 2306,
        "伊春市" => 2307,
        "佳木斯市" => 2308,
        "七台河市" => 2309,
        "牡丹江市" => 2310,
        "黑河市" => 2311,
        "绥化市" => 2312,
        "大兴安岭地区" => 2327,
    },

    "上海市" => phf_map! {
        "上海市" => 3101,
    },

    "江苏省" => phf_map! {
        "南京市" => 3201,
        "无锡市" => 3202,
        "徐州市" => 3203,
        "常州市" => 3204,
        "苏州市" => 3205,
        "南通市" => 3206,
        "连云港市" => 3207,
        "淮安市" => 3208,
        "盐城市" => 3209,
        "扬州市" => 3210,
        "镇江市" => 3211,
        "泰州市" => 3212,
        "宿迁市" => 3213,
    },

    "浙江省" => phf_map! {
        "杭州市" => 3301,
        "宁波市" => 3302,
        "温州市" => 3303,
        "嘉兴市" => 3304,
        "湖州市" => 3305,
        "绍兴市" => 3306,
        "金华市" => 3307,
        "衢州市" => 3308,
        "舟山市" => 3309,
        "台州市" => 3310,
        "丽水市" => 3311,
    },

    "安徽省" => phf_map! {
        "合肥市" => 3401,
        "芜湖市" => 3402,
        "蚌埠市" => 3403,
        "淮南市" => 3404,
        "马鞍山市" => 3405,
        "淮北市" => 3406,
        "铜陵市" => 3407,
        "安庆市" => 3408,
        "黄山市" => 3410,
        "滁州市" => 3411,
        "阜阳市" => 3412,
        "宿州市" => 3413,
        "六安市" => 3415,
        "亳州市" => 3416,
        "池州市" => 3417,
        "宣城市" => 3418,
    },

    "福建省" => phf_map! {
        "福州市" => 3501,
        "厦门市" => 3502,
        "莆田市" => 3503,
        "三明市" => 3504,
        "泉州市" => 3505,
        "漳州市" => 3506,
        "南平市" => 3507,
        "龙岩市" => 3508,
        "宁德市" => 3509,
    },

    "江西省" => phf_map! {
        "南昌市" => 3601,
        "景德镇市" => 3602,
        "萍乡市" => 3603,
        "九江市" => 3604,
        "新余市" => 3605,
        "鹰潭市" => 3606,
        "赣州市" => 3607,
        "吉安市" => 3608,
        "宜春市" => 3609,
        "抚州市" => 3610,
        "上饶市" => 3611,
    },

    "山东省" => phf_map! {
        "济南市" => 3701,
        "青岛市" => 3702,
        "淄博市" => 3703,
        "枣庄市" => 3704,
        "东营市" => 3705,
        "烟台市" => 3706,
        "潍坊市" => 3707,
        "济宁市" => 3708,
        "泰安市" => 3709,
        "威海市" => 3710,
        "日照市" => 3711,
        "临沂市" => 3713,
        "德州市" => 3714,
        "聊城市" => 3715,
        "滨州市" => 3716,
        "菏泽市" => 3717,
    },

    "河南省" => phf_map! {
        "郑州市" => 4101,
        "开封市" => 4102,
        "洛阳市" => 4103,
        "平顶山市" => 4104,
        "安阳市" => 4105,
        "鹤壁市" => 4106,
        "新乡市" => 4107,
        "焦作市" => 4108,
        "濮阳市" => 4109,
        "许昌市" => 4110,
        "漯河市" => 4111,
        "三门峡市" => 4112,
        "南阳市" => 4113,
        "商丘市" => 4114,
        "信阳市" => 4115,
        "周口市" => 4116,
        "驻马店市" => 4117,
        "省直辖县级行政区划" => 4190,
    },

    "湖北省" => phf_map! {
        "武汉市" => 4201,
        "黄石市" => 4202,
        "十堰市" => 4203,
        "宜昌市" => 4205,
        "襄阳市" => 4206,
        "鄂州市" => 4207,
        "荆门市" => 4208,
        "孝感市" => 4209,
        "荆州市" => 4210,
        "黄冈市" => 4211,
        "咸宁市" => 4212,
        "随州市" => 4213,
        "恩施土家族苗族自治州" => 4228,
        "省直辖县级行政区划" => 4290,
    },

    "湖南省" => phf_map! {
        "长沙市" => 4301,
        "株洲市" => 4302,
        "湘潭市" => 4303,
        "衡阳市" => 4304,
        "邵阳市" => 4305,
        "岳阳市" => 4306,
        "常德市" => 4307,
        "张家界市" => 4308,
        "益阳市" => 4309,
        "郴州市" => 4310,
        "永州市" => 4311,
        "怀化市" => 4312,
        "娄底市" => 4313,
        "湘西土家族苗族自治州" => 4331,
    },

    "广东省" => phf_map! {
        "广州市" => 4401,
        "韶关市" => 4402,
        "深圳市" => 4403,
        "珠海市" => 4404,
        "汕头市" => 4405,
        "佛山市" => 4406,
        "江门市" => 4407,
        "湛江市" => 4408,
        "茂名市" => 4409,
        "肇庆市" => 4412,
        "惠州市" => 4413,
        "梅州市" => 4414,
        "汕尾市" => 4415,
        "河源市" => 4416,
        "阳江市" => 4417,
        "清远市" => 4418,
        "东莞市" => 4419,
        "中山市" => 4420,
        "潮州市" => 4451,
        "揭阳市" => 4452,
        "云浮市" => 4453,
    },

    "广西自治区" => phf_map! {
        "南宁市" => 4501,
        "柳州市" => 4502,
        "桂林市" => 4503,
        "梧州市" => 4504,
        "北海市" => 4505,
        "防城港市" => 4506,
        "钦州市" => 4507,
        "贵港市" => 4508,
        "玉林市" => 4509,
        "百色市" => 4510,
        "贺州市" => 4511,
        "河池市" => 4512,
        "来宾市" => 4513,
        "崇左市" => 4514,
    },

    "海南省" => phf_map! {
        "海口市" => 4601,
        "三亚市" => 4602,
        "三沙市" => 4603,
        "儋州市" => 4604,
        "省直辖县级行政区划" => 4690,
    },

    "重庆市" => phf_map! {
        "重庆市" => 5001,
        "县" => 5002,
    },

    "四川省" => phf_map! {
        "成都市" => 5101,
        "自贡市" => 5103,
        "攀枝花市" => 5104,
        "泸州市" => 5105,
        "德阳市" => 5106,
        "绵阳市" => 5107,
        "广元市" => 5108,
        "遂宁市" => 5109,
        "内江市" => 5110,
        "乐山市" => 5111,
        "南充市" => 5113,
        "眉山市" => 5114,
        "宜宾市" => 5115,
        "广安市" => 5116,
        "达州市" => 5117,
        "雅安市" => 5118,
        "巴中市" => 5119,
        "资阳市" => 5120,
        "阿坝藏族羌族自治州" => 5132,
        "甘孜藏族自治州" => 5133,
        "凉山彝族自治州" => 5134,
    },

    "贵州省" => phf_map! {
        "贵阳市" => 5201,
        "六盘水市" => 5202,
        "遵义市" => 5203,
        "安顺市" => 5204,
        "毕节市" => 5205,
        "铜仁市" => 5206,
        "黔西南布依族苗族自治州" => 5223,
        "黔东南苗族侗族自治州" => 5226,
        "黔南布依族苗族自治州" => 5227,
    },

    "云南省" => phf_map! {
        "昆明市" => 5301,
        "曲靖市" => 5303,
        "玉溪市" => 5304,
        "保山市" => 5305,
        "昭通市" => 5306,
        "丽江市" => 5307,
        "普洱市" => 5308,
        "临沧市" => 5309,
        "楚雄彝族自治州" => 5323,
        "红河哈尼族彝族自治州" => 5325,
        "文山壮族苗族自治州" => 5326,
        "西双版纳傣族自治州" => 5328,
        "大理白族自治州" => 5329,
        "德宏傣族景颇族自治州" => 5331,
        "怒江傈僳族自治州" => 5333,
        "迪庆藏族自治州" => 5334,
    },

    "西藏自治区" => phf_map! {
        "拉萨市" => 5401,
        "日喀则市" => 5402,
        "昌都市" => 5403,
        "林芝市" => 5404,
        "山南市" => 5405,
        "那曲市" => 5406,
        "阿里地区" => 5425,
    },

    "陕西省" => phf_map! {
        "西安市" => 6101,
        "铜川市" => 6102,
        "宝鸡市" => 6103,
        "咸阳市" => 6104,
        "渭南市" => 6105,
        "延安市" => 6106,
        "汉中市" => 6107,
        "榆林市" => 6108,
        "安康市" => 6109,
        "商洛市" => 6110,
    },

    "甘肃省" => phf_map! {
        "兰州市" => 6201,
        "嘉峪关市" => 6202,
        "金昌市" => 6203,
        "白银市" => 6204,
        "天水市" => 6205,
        "武威市" => 6206,
        "张掖市" => 6207,
        "平凉市" => 6208,
        "酒泉市" => 6209,
        "庆阳市" => 6210,
        "定西市" => 6211,
        "陇南市" => 6212,
        "临夏回族自治州" => 6229,
        "甘南藏族自治州" => 6230,
    },

    "青海省" => phf_map! {
        "西宁市" => 6301,
        "海东市" => 6302,
        "海北藏族自治州" => 6322,
        "黄南藏族自治州" => 6323,
        "海南藏族自治州" => 6325,
        "果洛藏族自治州" => 6326,
        "玉树藏族自治州" => 6327,
        "海西蒙古族藏族自治州" => 6328,
    },

    "宁夏自治区" => phf_map! {
        "银川市" => 6401,
        "石嘴山市" => 6402,
        "吴忠市" => 6403,
        "固原市" => 6404,
        "中卫市" => 6405,
    },

    "新疆自治区" => phf_map! {
        "乌鲁木齐市" => 6501,
        "克拉玛依市" => 6502,
        "吐鲁番市" => 6504,
        "哈密市" => 6505,
        "昌吉回族自治州" => 6523,
        "博尔塔拉蒙古自治州" => 6527,
        "巴音郭楞蒙古自治州" => 6528,
        "阿克苏地区" => 6529,
        "克孜勒苏柯尔克孜自治州" => 6530,
        "喀什地区" => 6531,
        "和田地区" => 6532,
        "伊犁哈萨克自治州" => 6540,
        "塔城地区" => 6542,
        "阿勒泰地区" => 6543,
        "自治区直辖县级行政区划" => 6590,
    },

    "台湾省" => phf_map! {
        "台北市" => 7101, // 示例数据中仅有此项
    },

    "香港" => phf_map! {
        "香港岛" => 8101,
    },

    "澳门" => phf_map! {
        "澳门半岛" => 8201,
    },
};

/// 获取省份code
/// 支持带"省"或不带"省"的匹配，例如："浙江省" 或 "浙江"
pub fn get_province_code(province_name: &str) -> Option<i16> {
    // 先尝试直接匹配
    if let Some(code) = PROVINCE_MAP.get(province_name).copied() {
        return Some(code);
    }

    // 如果没找到，尝试添加"省"字后匹配
    let with_suffix = format!("{}省", province_name);
    if let Some(code) = PROVINCE_MAP.get(&with_suffix).copied() {
        return Some(code);
    }

    // 如果还是没找到，尝试去掉"省"字后匹配
    let without_suffix = province_name.trim_end_matches("省");
    if without_suffix != province_name {
        if let Some(code) = PROVINCE_MAP.get(without_suffix).copied() {
            return Some(code);
        }
    }

    // 特殊处理：自治区、直辖市等
    let variants = vec![
        format!("{}自治区", province_name),
        format!("{}市", province_name),
    ];
    for variant in variants {
        if let Some(code) = PROVINCE_MAP.get(&variant).copied() {
            return Some(code);
        }
    }

    None
}

/// 获取城市code
///
/// 逻辑：
/// 1. 如果提供了 province_name，先尝试在该省份下查找
/// 2. 如果没提供 province_name，或者在指定省份下没找到，则在所有省份下查找
/// 支持带"市"或不带"市"的匹配，例如："杭州市" 或 "杭州"
pub fn get_city_code(province_name: Option<&str>, city_name: &str) -> Option<i16> {
    // 辅助函数：尝试匹配城市（支持带/不带"市"）
    let try_match_city = |city_map: &phf::Map<&str, i16>, name: &str| -> Option<i16> {
        // 先尝试直接匹配
        if let Some(code) = city_map.get(name).copied() {
            return Some(code);
        }
        // 尝试添加"市"字
        let with_suffix = format!("{}市", name);
        if let Some(code) = city_map.get(&with_suffix).copied() {
            return Some(code);
        }
        // 尝试去掉"市"字
        let without_suffix = name.trim_end_matches("市");
        if without_suffix != name {
            if let Some(code) = city_map.get(without_suffix).copied() {
                return Some(code);
            }
        }
        None
    };

    // 1. 尝试在指定省份查找
    if let Some(prov) = province_name {
        // 先尝试直接匹配省份名
        if let Some(city_map) = PROVINCE_CITY_MAP.get(prov) {
            if let Some(code) = try_match_city(city_map, city_name) {
                return Some(code);
            }
        }
        // 如果省份名不带"省"，尝试添加"省"字
        let prov_with_suffix = format!("{}省", prov);
        if let Some(city_map) = PROVINCE_CITY_MAP.get(&prov_with_suffix) {
            if let Some(code) = try_match_city(city_map, city_name) {
                return Some(code);
            }
        }
        // 如果省份名带"省"，尝试去掉"省"字
        let prov_without_suffix = prov.trim_end_matches("省");
        if prov_without_suffix != prov {
            if let Some(city_map) = PROVINCE_CITY_MAP.get(prov_without_suffix) {
                if let Some(code) = try_match_city(city_map, city_name) {
                    return Some(code);
                }
            }
        }
    }

    // 2. 全局查找（fallback）
    for (_, city_map) in PROVINCE_CITY_MAP.entries() {
        if let Some(code) = try_match_city(city_map, city_name) {
            return Some(code);
        }
    }
    None
}
#[allow(dead_code)]
/// 只通过城市名查找code（不需要指定省份，会在所有省份下搜索）
pub fn get_city_code_by_name(city_name: &str) -> Option<i16> {
    get_city_code(None, city_name)
}
#[allow(dead_code)]
/// 智能查找：先尝试作为省份，再尝试在所有省份下查找城市
pub fn find_code(name: &str) -> Option<i16> {
    // 先尝试作为省份
    if let Some(code) = get_province_code(name) {
        return Some(code);
    }

    // 如果不是省份，尝试在所有省份下查找城市
    get_city_code_by_name(name)
}

/// 从试卷名称中匹配所有可能的城市
/// 返回匹配到的城市名称列表（可能为空或多个）
pub fn match_cities_from_paper_name(paper_name: &str, province_name: Option<&str>) -> Vec<String> {
    let mut matched_cities = Vec::new();

    // 如果提供了省份，优先在该省份的城市中查找
    if let Some(prov) = province_name {
        if let Some(city_map) = PROVINCE_CITY_MAP.get(prov) {
            for (city_name, _) in city_map.entries() {
                // 检查试卷名称中是否包含城市名称（去掉"市"字也尝试匹配）
                let city_without_suffix = city_name.trim_end_matches("市");
                if paper_name.contains(city_name) || paper_name.contains(city_without_suffix) {
                    matched_cities.push(city_name.to_string());
                }
            }
        }
    }

    // 如果已经在指定省份找到匹配，直接返回
    if !matched_cities.is_empty() {
        return matched_cities;
    }

    // 如果没找到或没提供省份，在所有城市中查找
    for (_, city_map) in PROVINCE_CITY_MAP.entries() {
        for (city_name, _) in city_map.entries() {
            let city_without_suffix = city_name.trim_end_matches("市");
            if paper_name.contains(city_name) || paper_name.contains(city_without_suffix) {
                // 避免重复添加
                if !matched_cities.contains(&city_name.to_string()) {
                    matched_cities.push(city_name.to_string());
                }
            }
        }
    }

    matched_cities
}

// # Reference Dictionary (参考字典 - 级联关系)
// **浙江省 (index=12)** 下属城市:
//   - 杭州市 (code: 3301)
//   - 宁波市 (code: 3302)
//   - 温州市 (code: 3303)
//   - 嘉兴市 (code: 3304)
//   - 湖州市 (code: 3305)
//   - 绍兴市 (code: 3306)
//   - 金华市 (code: 3307)
//   - 衢州市 (code: 3308)
//   - 舟山市 (code: 3309)
//   - 台州市 (code: 3310)
//   - 丽水市 (code: 3311)

// **江苏省 (index=11)** 下属城市:
//   - [这里可以补充江苏的城市...]
